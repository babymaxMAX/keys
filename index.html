<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>v2rayTun авто‑импорт</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;padding:24px;max-width:880px;margin:0 auto}
    h1{font-size:24px;margin:0 0 12px}.muted{color:#555}.hidden{display:none}.err{color:#b00020}
    a.btn{display:inline-block;padding:12px 16px;background:#0b57d0;color:#fff;border-radius:10px;text-decoration:none}
    a.btn.secondary{background:#5f6368}.row{margin-top:16px}code{background:#f6f8fa;padding:0 4px;border-radius:4px}
  </style>
</head>
<body>
  <h1>Авто‑импорт в v2rayTun</h1>
  <p id="status" class="muted">Готовим перенаправление…</p>

  <div id="actions" class="hidden">
    <p id="err" class="err"></p>

    <div id="inApp" class="hidden row">
      Открой ссылку во внешнем браузере, затем нажми “Открыть v2rayTun”.
      <div class="row"><a id="openExternal" class="btn secondary" href="#">Открыть в браузере</a></div>
    </div>

    <div id="buttons" class="row hidden">
      <a id="primary" class="btn" href="#">Открыть v2rayTun</a>
      <a id="alt" class="btn secondary" href="#" style="margin-left:8px;">Альтернатива</a>
    </div>

    <div id="fallback" class="row">
      <p class="muted">Запасной вариант — подписка:</p>
      <p><a id="subLink" class="btn secondary" href="#" target="_blank" rel="noopener">Открыть подписку</a></p>
      <p class="muted">Адрес: <code id="subText"></code></p>
    </div>
  </div>

  <script>
    const ua = navigator.userAgent||"";
    const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);
    const isInApp = /WhatsApp|FBAN|FBAV|Instagram|Line|VKClient|Telegram/i.test(ua);

    const qs = new URLSearchParams(location.search);
    const id = parseInt(qs.get('id'),10);

    const status = document.getElementById('status');
    const actions = document.getElementById('actions');
    const errEl = document.getElementById('err');
    const inApp = document.getElementById('inApp');
    const openExternal = document.getElementById('openExternal');
    const buttons = document.getElementById('buttons');
    const primary = document.getElementById('primary');
    const alt = document.getElementById('alt');
    const subLink = document.getElementById('subLink');
    const subText = document.getElementById('subText');

    if(!id){ status.textContent='Нужен ?id=1..300'; actions.classList.remove('hidden'); errEl.textContent='Нет параметра id.'; }

    const subUrl = location.origin + '/sub?id=' + id;
    subLink.href = subUrl; subText.textContent = subUrl;

    async function b64utf8(s){
      const bytes = new TextEncoder().encode(s);
      let bin=''; bytes.forEach(b=>bin+=String.fromCharCode(b));
      return btoa(bin);
    }

    (async ()=>{
      // SW для /sub
      if('serviceWorker' in navigator){
        try{
          await navigator.serviceWorker.register('/sw.js',{scope:'/'});
          if(!navigator.serviceWorker.controller) await new Promise(r=>setTimeout(r,150));
        }catch(_){}
      }

      let vless='';
      try{
        const r = await fetch(subUrl,{cache:'no-store'}); if(!r.ok) throw 0;
        vless = (await r.text()).trim();
      }catch(_){
        status.textContent='Не удалось получить конфиг.'; actions.classList.remove('hidden'); errEl.textContent='/sub?id='+id+' не доступен'; return;
      }

      actions.classList.remove('hidden');
      if(isInApp){ inApp.classList.remove('hidden'); openExternal.onclick=e=>{e.preventDefault(); window.open(location.href,'_blank');}; }

      // Подготовим кандидатов, включая base64-параметр config=
      const b64 = await b64utf8(vless);
      const candidates = [
        // наиболее вероятные для v2rayTun iOS/Android:
        { label:'v2raytun install-config (url)', url:'v2raytun://install-config?url='+encodeURIComponent(vless) },
        { label:'v2raytun import (url)',         url:'v2raytun://import?url='+encodeURIComponent(vless) },
        { label:'v2raytun import (config=base64)',url:'v2raytun://import?config='+encodeURIComponent(b64) },
        { label:'v2raytun install-config (config=base64)', url:'v2raytun://install-config?config='+encodeURIComponent(b64) },
        // совместимые пути некоторых сборок
        { label:'v2rayng install-config',        url:'v2rayng://install-config?url='+encodeURIComponent(vless) },
        { label:'raw vless://',                  url:vless }
      ];

      // кнопки
      primary.href = candidates[0].url;
      alt.href = candidates[1].url;
      buttons.classList.remove('hidden');

      // автозапуск цепочкой (на телефоне; внутри мессенджера может блокироваться)
      status.textContent='Пробуем авто‑импорт в v2rayTun…';
      if(isMobile){
        let i=0, done=false;
        const vis=()=>{ if(document.visibilityState==='hidden'){ done=true; cleanup(); } };
        const timers=[]; function cleanup(){ document.removeEventListener('visibilitychange',vis); timers.forEach(clearTimeout); }
        document.addEventListener('visibilitychange',vis);
        function step(){ if(done||i>=candidates.length) return; try{ location.href=candidates[i].url; }catch(_){} i++; timers.push(setTimeout(step,900)); }
        step();
        // дополнительный дубль
        const meta=document.createElement('meta'); meta.httpEquiv='refresh'; meta.content='0;url='+candidates[0].url; document.head.appendChild(meta);
      }else{
        status.textContent='Открой на телефоне с установленным v2rayTun.';
      }
    })();
  </script>
</body>
</html>
