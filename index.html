<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>v2rayTun авто‑импорт</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;padding:24px;max-width:880px;margin:0 auto}
    h1{font-size:24px;margin:0 0 12px}
    .muted{color:#555}.hidden{display:none}.err{color:#b00020}
    a.btn{display:inline-block;padding:12px 16px;background:#0b57d0;color:#fff;border-radius:10px;text-decoration:none}
    a.btn.secondary{background:#5f6368}
    code{background:#f6f8fa;padding:0 4px;border-radius:4px}
    .row{margin-top:16px} ul{margin:8px 0 0 18px}
  </style>
</head>
<body>
  <h1>Авто‑импорт в v2rayTun</h1>
  <p id="status" class="muted">Готовим перенаправление…</p>

  <div id="actions" class="hidden">
    <p id="err" class="err"></p>

    <div id="waHint" class="hidden muted row">
      Если открыто из мессенджера, нажми «Открыть в браузере», затем «Открыть v2rayTun».
      <div class="row"><a id="openExternal" class="btn secondary" href="#" rel="noopener">Открыть в браузере</a></div>
    </div>

    <div id="runBlock" class="hidden row">
      <a id="openPrimary" class="btn" href="#" rel="noopener">Открыть v2rayTun</a>
      <a id="openAlt" class="btn secondary" href="#" rel="noopener" style="margin-left:8px;">Альтернатива</a>
    </div>

    <div id="altBlock" class="hidden row">
      <p class="muted">Другие варианты запуска:</p>
      <ul id="altList"></ul>
    </div>

    <div id="fallbackBlock" class="row">
      <p class="muted">Запасной вариант — подписка (импорт внутри приложения):</p>
      <p><a id="subLink" class="btn secondary" href="#" target="_blank" rel="noopener">Открыть подписку</a></p>
      <p class="muted">Адрес: <code id="subText"></code></p>
      <p class="muted">Или скопируй конфиг вручную:</p>
      <p><a id="copyBtn" class="btn secondary" href="#">Скопировать VLESS</a></p>
      <p id="copied" class="muted hidden">Скопировано.</p>
    </div>
  </div>

  <script>
    const ua = navigator.userAgent||"";
    const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);
    const isInApp = /WhatsApp|FBAN|FBAV|Instagram|Line|VKClient|Telegram/i.test(ua);

    const qs = new URLSearchParams(location.search);
    const id = parseInt(qs.get('id'),10);
    const status = document.getElementById('status');
    const actions = document.getElementById('actions');
    const errEl = document.getElementById('err');
    const waHint = document.getElementById('waHint');
    const openExternal = document.getElementById('openExternal');
    const runBlock = document.getElementById('runBlock');
    const openPrimary = document.getElementById('openPrimary');
    const openAlt = document.getElementById('openAlt');
    const altBlock = document.getElementById('altBlock');
    const altList = document.getElementById('altList');
    const subLink = document.getElementById('subLink');
    const subText = document.getElementById('subText');
    const copyBtn = document.getElementById('copyBtn');
    const copied = document.getElementById('copied');

    if(!id){ status.textContent='Нужен параметр ?id=1..300'; actions.classList.remove('hidden'); errEl.textContent='Параметр ?id= отсутствует.'; }

    const subUrl = location.origin + '/sub?id=' + id;
    subLink.href = subUrl; subText.textContent = subUrl;

    (async() => {
      // SW нужен только для /sub — если его нет, всё равно продолжим
      if('serviceWorker' in navigator){
        try{
          await navigator.serviceWorker.register('/sw.js',{scope:'/'});
          if(!navigator.serviceWorker.controller) await new Promise(r=>setTimeout(r,150));
        }catch(_){}
      }

      let vless = '';
      try{
        const r = await fetch(subUrl,{cache:'no-store'}); if(!r.ok) throw 0;
        vless = (await r.text()).trim();
      }catch(_){
        actions.classList.remove('hidden'); errEl.textContent='Не удалось получить конфиг /sub?id='+id; status.textContent='Ошибка загрузки.'; return;
      }

      actions.classList.remove('hidden');
      if(isInApp){ waHint.classList.remove('hidden'); openExternal.onclick=e=>{e.preventDefault(); window.open(location.href,'_blank');}; }

      // Набор схем, которые последовательно пробуем
      const candidates = [
        {label:'v2rayTun install-config', url:'v2raytun://install-config?url='+encodeURIComponent(vless)},
        {label:'v2rayTun import',         url:'v2raytun://import?url='+encodeURIComponent(vless)},
        {label:'v2rayNG install-config',  url:'v2rayng://install-config?url='+encodeURIComponent(vless)},
        {label:'vless:// (raw)',          url:vless}
      ];

      // Кнопки
      openPrimary.href = candidates[0].url;
      openAlt.href = candidates[1].url;
      altList.innerHTML='';
      candidates.forEach(c=>{ const li=document.createElement('li'); const a=document.createElement('a'); a.href=c.url; a.className='btn secondary'; a.textContent=c.label; a.style.display='inline-block'; a.style.marginTop='8px'; li.appendChild(a); altList.appendChild(li); });
      altBlock.classList.remove('hidden');
      runBlock.classList.remove('hidden');

      // Копирование
      copyBtn.onclick = async (e)=>{ e.preventDefault(); try{ await navigator.clipboard.writeText(vless); copied.classList.remove('hidden'); setTimeout(()=>copied.classList.add('hidden'),1200);}catch(_){} };

      // Автозапуск цепочкой
      status.textContent = 'Пробуем открыть v2rayTun…';
      if(isMobile){
        let i = 0, gone = false;
        const vis = ()=>{ if(document.visibilityState==='hidden'){ gone=true; cleanup(); } };
        const timers=[]; function cleanup(){ document.removeEventListener('visibilitychange',vis); timers.forEach(clearTimeout); }
        document.addEventListener('visibilitychange',vis);
        function step(){ if(gone||i>=candidates.length) return; try{ location.href = candidates[i].url; }catch(_){ } i++; timers.push(setTimeout(step,900)); }
        // сразу пробуем + дубль через meta refresh
        step(); const meta=document.createElement('meta'); meta.httpEquiv='refresh'; meta.content='0;url='+candidates[0].url; document.head.appendChild(meta);
      }else{
        status.textContent='Открой на телефоне с v2rayTun или используй подписку/копирование.';
      }
    })();
  </script>
</body>
</html>
