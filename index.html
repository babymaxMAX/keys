<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>VPN auto-import</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;padding:24px;max-width:880px;margin:0 auto}
    .hidden{display:none}.err{color:#b00020}
    a.btn{display:inline-block;padding:10px 14px;background:#0b57d0;color:#fff;border-radius:8px;text-decoration:none}
    a.btn.secondary{background:#5f6368}
    code{background:#f6f8fa;padding:0 4px;border-radius:4px}
  </style>
</head>
<body>
  <h1>Авто‑импорт профиля</h1>
  <p id="status">Готовим перенаправление…</p>

  <div id="actions" class="hidden">
    <p class="err" id="err"></p>
    <p>
      <a id="openPrimary" class="btn" href="#">Открыть</a>
      <a id="openAlt" class="btn secondary" href="#" style="margin-left:8px;">Альтернатива</a>
    </p>
    <p id="iosHelp" class="hidden">
      Если не открылось — в Shadowrocket нажми “+”, затем “Subscribe” и вставь ссылку: <code id="subUrl"></code>
    </p>
  </div>

  <script>
    const isAndroid = /Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    function getId(){
      const id = parseInt(new URLSearchParams(location.search).get('id'), 10);
      return Number.isFinite(id) ? id : null;
    }

    async function ensureSW(){
      if(!('serviceWorker' in navigator)) return;
      try{
        const reg = await navigator.serviceWorker.register('/sw.js', {scope:'/'});
        if(!navigator.serviceWorker.controller){
          await new Promise(r => setTimeout(r, 200));
        }
      }catch(e){}
    }

    async function fetchVLESS(id){
      const res = await fetch('/sub?id='+id, {cache:'no-store'});
      if(!res.ok) throw new Error('sub '+res.status);
      return (await res.text()).trim();
    }

    function v2rayngLink(vless){
      return 'v2rayng://install-config?url='+encodeURIComponent(vless);
    }
    function androidIntent(vless){
      const qs = 'install-config?url='+encodeURIComponent(vless);
      return 'intent://'+qs+'#Intent;scheme=v2rayng;package=com.v2ray.ang;end';
    }
    function shadowrocketSubLink(subUrl){
      return 'shadowrocket://add/sub?url='+encodeURIComponent(subUrl);
    }

    (async function main(){
      const status = document.getElementById('status');
      const actions = document.getElementById('actions');
      const errEl = document.getElementById('err');
      const openPrimary = document.getElementById('openPrimary');
      const openAlt = document.getElementById('openAlt');
      const iosHelp = document.getElementById('iosHelp');
      const subUrlEl = document.getElementById('subUrl');

      const id = getId();
      if(!id){ status.textContent='Нужен параметр ?id=1..300'; actions.classList.remove('hidden'); errEl.textContent='Параметр ?id= отсутствует.'; return; }

      await ensureSW();

      const subUrl = location.origin + '/sub?id=' + id; // для iOS подписки
      try{
        const vless = await fetchVLESS(id);

        if(isAndroid){
          const deep = v2rayngLink(vless);
          const alt = androidIntent(vless);

          // мгновенный переход
          try{ location.replace(deep); }catch(e){}
          // мета‑редирект как дубль
          const meta=document.createElement('meta'); meta.httpEquiv='refresh'; meta.content='0;url='+deep; document.head.appendChild(meta);

          // показать кнопки на случай блокировки in-app браузером
          setTimeout(()=> {
            status.textContent='Если не открылось — нажми кнопку ниже.';
            actions.classList.remove('hidden');
            openPrimary.href = deep; openPrimary.textContent='Открыть в v2rayNG/v2rayTun';
            openAlt.href = alt; openAlt.textContent='Через intent';
          }, 1200);
          return;
        }

        if(isIOS){
          // Основной путь для iOS — подписка Shadowrocket
          const rocket = shadowrocketSubLink(subUrl);
          try{ location.replace(rocket); }catch(e){}
          const meta=document.createElement('meta'); meta.httpEquiv='refresh'; meta.content='0;url='+rocket; document.head.appendChild(meta);

          setTimeout(()=> {
            status.textContent='Нажми “Открыть” для импорта в Shadowrocket.';
            actions.classList.remove('hidden');
            openPrimary.href = rocket; openPrimary.textContent='Открыть в Shadowrocket';
            openAlt.href = subUrl; openAlt.textContent='Показать ссылку подписки';
            iosHelp.classList.remove('hidden'); subUrlEl.textContent=subUrl;
          }, 1200);
          return;
        }

        // Десктоп/прочее — показать ссылку подписки
        status.textContent='Открой на телефоне по ссылке подписки (или скопируй конфиг).';
        actions.classList.remove('hidden');
        openPrimary.href = subUrl; openPrimary.textContent='Ссылка подписки (iOS)';
        openAlt.href = v2rayngLink(vless); openAlt.textContent='Ссылка (Android)';
        iosHelp.classList.remove('hidden'); subUrlEl.textContent=subUrl;

      }catch(e){
        status.textContent='Ошибка загрузки ключа.';
        actions.classList.remove('hidden');
        errEl.textContent='Ключ не найден или сервис‑воркер не активировался. Обнови страницу и проверь ?id=1..300.';
      }
    })();
  </script>
</body>
</html>
