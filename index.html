<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>LsJ VPN ‚Äî –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#111111">
  <style>
    :root{--bg-1:#0b0b0f;--bg-2:#101218;--brand:#f7c23e;--brand-2:#ff9900;--text:#e9edf3;--muted:#a7adba;--line:rgba(255,255,255,0.12);--glow:rgba(247,194,62,0.25)}
    html,body{height:100%}
    body{margin:0;color:var(--text);background:radial-gradient(1200px 800px at 70% -10%,#1c2135 0%,transparent 70%),radial-gradient(900px 700px at 0% 100%,#1b1626 0%,transparent 65%),linear-gradient(180deg,var(--bg-1),var(--bg-2));font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .shell{max-width:880px;margin:0 auto;padding:28px 18px 40px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--line);border-radius:18px;padding:22px 18px;box-shadow:0 10px 35px rgba(0,0,0,.45),0 0 80px 0 var(--glow);backdrop-filter:blur(6px)}
    .brand{display:flex;align-items:center;gap:16px;margin:10px 0 16px}
    .logo{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;background:radial-gradient(circle at 50% 40%,var(--brand) 0%,var(--brand-2) 60%,#a96700 100%);box-shadow:0 0 30px var(--glow),0 8px 24px rgba(0,0,0,.45)}
    .title{font-weight:900;font-size:28px}
    .sub{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:18px 0}
    .h2{font-size:18px;font-weight:800;margin:14px 0 10px}
    p{margin:8px 0 10px}
    .muted{color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:640px){.grid2{grid-template-columns:1fr 1fr}}
    .btn{appearance:none;border:none;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:10px;font-weight:800;font-size:16px;border-radius:14px;padding:14px 16px;min-height:54px;width:100%;color:#101015;transition:transform .08s,box-shadow .14s,filter .14s}
    .btn:active{transform:translateY(1px) scale(.995)}
    .btn-primary{background:linear-gradient(180deg,var(--brand) 0%,var(--brand-2) 86%);box-shadow:0 14px 36px rgba(247,194,62,.28),0 2px 0 rgba(255,255,255,.18) inset}
    .btn-ghost{color:#e9edf3;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--line);box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .btn-store{background:linear-gradient(180deg,#1e2435,#151a28);color:#e7ebf5;border:1px solid var(--line)}
    .note{font-size:13px;color:var(--muted)}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(30px);background:#0f1220;color:#e9edf3;border:1px solid var(--line);padding:10px 14px;border-radius:10px;opacity:0;transition:.22s;pointer-events:none;box-shadow:0 10px 30px rgba(0,0,0,.55);font-size:14px}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .hid{display:none}
  </style>
</head>
<body>
  <div class="shell">
    <div class="brand">
      <div class="logo" aria-hidden="true"><svg width="34" height="34" viewBox="0 0 24 24" fill="#111"><path d="M12 2l.894 2.763h2.905l-2.351 1.708.897 2.762L12 7.525 9.655 9.233l.897-2.762L8.2 4.763h2.905L12 2z"/></svg></div>
      <div><div class="title">LsJ VPN</div><div class="sub">Comrades ‚Ä¢ Premium Access</div></div>
    </div>

    <div class="card">
      <div style="font-size:18px;font-weight:800;margin-bottom:6px">üíª LsJ VPN –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</div>
      <p>–ê—Å—Å–∞–ª–∞–º—É –∞–ª–µ–π–∫—É–º! –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π VPN ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ.</p>

      <div class="hr"></div>

      <div class="h2">1Ô∏è‚É£ –°–∫–∞—á–∞–π—Ç–µ v2raytun</div>
      <div class="grid2">
        <a class="btn btn-store" href="https://apps.apple.com/ru/app/v2raytun/id6476628951" target="_blank" rel="noopener">Ô£ø macOS / Mac</a>
        <a class="btn btn-store" href="https://apps.apple.com/ru/app/v2raytun/id6476628951?l=en-GB" target="_blank" rel="noopener">Ô£ø iPhone / iOS</a>
        <a class="btn btn-store" href="https://play.google.com/store/apps/details?id=com.v2raytun.android&hl=ru" target="_blank" rel="noopener">ü§ñ Android</a>
        <a class="btn btn-store" href="https://storage.v2raytun.com/v2RayTun_Setup.exe" target="_blank" rel="noopener">ü™ü Windows</a>
      </div>

      <div class="h2" style="margin-top:16px">2Ô∏è‚É£ –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–ª—é—á</div>
      <div class="grid2">
        <a id="btnIOS" class="btn btn-primary" href="#">üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å VPN iPhone / Mac</a>
        <a id="btnAW" class="btn btn-ghost" href="#">‚ö° –ü–æ–¥–∫–ª—é—á–∏—Ç—å VPN Android / Windows</a>
      </div>

      <div class="grid2" style="margin-top:12px">
        <button id="btnCopy" class="btn btn-ghost" type="button">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
      </div>

      <div class="h2" style="margin-top:16px">3Ô∏è‚É£ –ó–∞–ø—É—Å—Ç–∏—Ç–µ v2raytun</div>
      <p>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –±–æ–ª—å—à—É—é —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>

      <div class="hr"></div>

      <div class="h2">‚ö†Ô∏è –í–∞–∂–Ω–æ</div>
      <p class="note">–û–¥–∏–Ω –∫–ª—é—á ‚Äî –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. –ù–µ –ø–µ—Ä–µ—Å—ã–ª–∞–π—Ç–µ –µ–≥–æ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.</p>
    </div>
  </div>

  <div id="toast" class="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>

  <script>
    // UA flags
    const ua = navigator.userAgent || "";
    const isAndroid = /Android/i.test(ua);
    const isWindows = /Windows NT|Win64|Win32/i.test(ua);
    const isInApp  = /WhatsApp|FBAN|FBAV|Instagram|Line|VKClient|Telegram/i.test(ua);

    // UI refs
    const btnIOS  = document.getElementById('btnIOS');
    const btnAW   = document.getElementById('btnAW');
    const btnCopy = document.getElementById('btnCopy');
    const toast   = document.getElementById('toast');

    // id from query
    const qs = new URLSearchParams(location.search);
    const id = parseInt(qs.get('id'), 10);

    // Deep link helpers (V2RayTun official)
    const makeTunDeep = (payload) => 'v2raytun://import/' + encodeURIComponent(payload);
    const makeIntent  = (payload) => 'intent://import/' + encodeURIComponent(payload) + '#Intent;scheme=v2raytun;package=com.v2raytun.android;end';

    // Robust data probe:
    // 1) /vless?id=N (raw vless://...) ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å
    // 2) /sub?id=N (–µ—Å–ª–∏ base64 ‚Äî —ç—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞; –µ—Å–ª–∏ vless:// ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ raw)
    async function probeData() {
      let vlessRaw = null, hasSubscription = false;
      // try /vless
      try {
        const r = await fetch('/vless?id='+id, { cache:'no-store' });
        if (r.ok) {
          const t = (await r.text()).trim();
          if (/^vless:\/\//i.test(t)) vlessRaw = t;
        }
      } catch (_) {}
      // try /sub
      const subUrl = location.origin + '/sub?id=' + id;
      try {
        const r2 = await fetch(subUrl, { cache:'no-store' });
        if (r2.ok) {
          const t2 = (await r2.text()).trim();
          if (/^vless:\/\//i.test(t2)) { if (!vlessRaw) vlessRaw = t2; }
          else {
            // Heuristic for base64 subscription
            const looksB64 = /^[A-Za-z0-9+/=\r\n]+$/.test(t2) && t2.length > 60;
            hasSubscription = looksB64;
          }
        }
      } catch (_) {}
      return { vlessRaw, hasSubscription, subUrl };
    }

    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1300); }

    async function ensureSW(){
      if(!('serviceWorker' in navigator)) return;
      try{
        await navigator.serviceWorker.register('/sw.js',{scope:'/'});
        if(!navigator.serviceWorker.controller) await new Promise(r=>setTimeout(r,120));
      }catch(_){}
    }

    async function init(){
      if (!Number.isFinite(id) || id < 1) {
        btnIOS.classList.add('hid'); btnAW.classList.add('hid'); btnCopy.classList.add('hid'); return;
      }
      await ensureSW();

      const { vlessRaw, hasSubscription, subUrl } = await probeData();

      // iOS/Mac ‚Äî –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º raw VLESS; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞
      const iosPayload = vlessRaw ?? subUrl;
      btnIOS.href = makeTunDeep(iosPayload);

      // Android/Windows ‚Äî –ø–æ –¢–ó: –¥–∏–ø–ª–∏–Ω–∫ v2raytun://import/{ENCODED(payload)}
      // payload: –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∞ ‚Äî –ª—É—á—à–µ –µ—ë; –∏–Ω–∞—á–µ raw VLESS; –µ—Å–ª–∏ –Ω–∏ —Ç–æ–≥–æ, –Ω–∏ –¥—Ä—É–≥–æ–≥–æ ‚Äî –æ—Å—Ç–∞—ë—Ç—Å—è subUrl –∫–∞–∫ –∑–∞–ø–∞—Å.
      const primaryPayload = hasSubscription ? subUrl : (vlessRaw ?? subUrl);
      const deepAW   = makeTunDeep(primaryPayload);
      const intentAW = makeIntent(primaryPayload);

      btnAW.onclick = (e)=>{
        e.preventDefault();
        // 1) v2raytun deep
        try { location.href = deepAW; } catch(_) {}
        // 2) fallback: Android ‚Üí Intent; Windows ‚Üí –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        setTimeout(()=>{ if (isAndroid) { try { location.href = intentAW; } catch(_) {} } else if (isWindows) { try { location.href = subUrl; } catch(_) {} } }, 800);
      };

      // Copy: –µ—Å–ª–∏ –µ—Å—Ç—å raw vless ‚Äî –∫–æ–ø–∏—Ä—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ ‚Äî URL –ø–æ–¥–ø–∏—Å–∫–∏
      btnCopy.onclick = async ()=>{
        const toCopy = vlessRaw ?? subUrl;
        try { await navigator.clipboard.writeText(toCopy); showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }
        catch {
          const ta=document.createElement('textarea'); ta.value=toCopy; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); ta.remove(); showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
        }
      };

      // Gentle auto-suggest for Android outside in-app
      if (isAndroid && !isInApp) {
        try { location.href = deepAW; } catch(_) {}
        setTimeout(()=>{ try { location.href = intentAW; } catch(_) {} }, 900);
      }
    }

    init().catch(console.error);
  </script>
</body>
</html>
