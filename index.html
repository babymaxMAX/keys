<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>v2rayTun авто‑импорт</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;padding:24px;max-width:880px;margin:0 auto}
    h1{font-size:24px;margin:0 0 12px}
    .muted{color:#555}.err{color:#b00020}.hidden{display:none}
    a.btn{display:inline-block;padding:12px 16px;background:#0b57d0;color:#fff;border-radius:10px;text-decoration:none}
    a.btn.secondary{background:#5f6368}
    code{background:#f6f8fa;padding:0 4px;border-radius:4px}
    .row{margin-top:16px}
  </style>
</head>
<body>
  <h1>Авто‑импорт в v2rayTun</h1>
  <p id="status" class="muted">Готовим конфигурацию…</p>

  <div id="ui" class="hidden">
    <p id="err" class="err hidden"></p>

    <div id="inapp" class="hidden row">
      Открыто во встроенном просмотрщике. Нажми «Открыть в браузере», затем «Открыть v2rayTun».
      <div class="row"><a id="openExternal" class="btn secondary" href="#" rel="noopener">Открыть в браузере</a></div>
    </div>

    <div class="row">
      <a id="btnOpen" class="btn" href="#" rel="noopener">Открыть v2rayTun</a>
      <a id="btnSub" class="btn secondary" href="#" rel="noopener" style="margin-left:8px;">Через подписку</a>
    </div>

    <div class="row">
      <p class="muted">Если не сработало — ссылка подписки для ручного импорта:</p>
      <p><a id="subLink" class="btn secondary" href="#" target="_blank" rel="noopener">Открыть подписку</a></p>
      <p class="muted">Адрес: <code id="subTxt"></code></p>
    </div>
  </div>

  <script>
    const ua = navigator.userAgent||"";
    const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);
    const isInApp = /WhatsApp|FBAN|FBAV|Instagram|Line|VKClient|Telegram/i.test(ua);

    const qs = new URLSearchParams(location.search);
    const id = parseInt(qs.get('id'),10);

    const statusEl = document.getElementById('status');
    const ui = document.getElementById('ui');
    const errEl = document.getElementById('err');
    const inapp = document.getElementById('inapp');
    const openExternal = document.getElementById('openExternal');
    const btnOpen = document.getElementById('btnOpen');
    const btnSubBtn = document.getElementById('btnSub');
    const subLink = document.getElementById('subLink');
    const subTxt = document.getElementById('subTxt');

    if(!Number.isFinite(id) || id < 1){
      statusEl.textContent = 'Нужен параметр ?id=1..300';
    } else {
      run().catch(e=>{
        ui.classList.remove('hidden');
        errEl.classList.remove('hidden');
        errEl.textContent = 'Ошибка: ' + (e && e.message ? e.message : 'не удалось подготовить ссылку');
      });
    }

    // SW нужен лишь для /sub; если не взлетит — просто продолжим
    async function ensureSW(){
      if(!('serviceWorker' in navigator)) return;
      try{
        await navigator.serviceWorker.register('/sw.js',{scope:'/'});
        if(!navigator.serviceWorker.controller) await new Promise(r=>setTimeout(r,150));
      }catch(_){}
    }

    async function getVLESS(n){
      const r = await fetch('/sub?id='+n,{cache:'no-store'});
      if(!r.ok) throw new Error('sub?id='+n+' недоступен');
      return (await r.text()).trim();
    }

    function mkDeepFromVless(vless){
      return 'v2raytun://import/' + encodeURIComponent(vless);
    }
    function mkDeepFromSub(subUrl){
      return 'v2raytun://import/' + encodeURIComponent(subUrl);
    }

    async function run(){
      await ensureSW();

      statusEl.textContent = 'Загружаем ключ…';
      const vless = await getVLESS(id);
      if(!/^vless:\/\//i.test(vless)) throw new Error('Ключ не vless://');

      // Основной диплинк: импорт одной VLESS‑ссылки
      const deeplink = mkDeepFromVless(vless);

      // Альтернатива: импорт подписки (тот же id)
      const subUrl = location.origin + '/sub?id=' + id;
      const subDeep = mkDeepFromSub(subUrl);

      // Кнопки/подписка
      btnOpen.href = deeplink;
      btnSubBtn.href = subDeep;
      subLink.href = subUrl;
      subTxt.textContent = subUrl;

      ui.classList.remove('hidden');

      if(isInApp){
        inapp.classList.remove('hidden');
        openExternal.addEventListener('click',(e)=>{ e.preventDefault(); window.open(location.href,'_blank'); });
        statusEl.textContent = 'Нажми «Открыть в браузере», затем «Открыть v2rayTun».';
        return;
      }

      // Автозапуск: сначала импорт одной VLESS, через секунду — импорт по подписке как дубль
      statusEl.textContent = 'Пробуем авто‑импорт…';
      if(isMobile){
        try{ location.href = deeplink; }catch(_){}
        setTimeout(()=>{ try{ location.href = subDeep; }catch(_){}} , 1000);
      }else{
        statusEl.textContent = 'Открой на телефоне или нажми кнопку.';
      }
    }
  </script>
</body>
</html>
