<script>
  const ua = navigator.userAgent || "";
  const isAndroid = /Android/i.test(ua);

  const qs = new URLSearchParams(location.search);
  const id = parseInt(qs.get('id'), 10);

  const btnIOS = document.getElementById('btnIOS');
  const btnAndroid = document.getElementById('btnAndroid');
  const btnCopy = document.getElementById('btnCopy');
  const toast = document.getElementById('toast');

  if (!Number.isFinite(id) || id < 1) {
    btnIOS.classList.add('hid');
    btnAndroid.classList.add('hid');
    btnCopy.classList.add('hid');
  } else {
    init().catch(console.error);
  }

  async function ensureSW(){
    if(!('serviceWorker' in navigator)) return;
    try{
      await navigator.serviceWorker.register('/sw.js',{scope:'/'});
      if(!navigator.serviceWorker.controller) await new Promise(r=>setTimeout(r,150));
    }catch(_){}
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1300);
  }

  // deep links
  const deepV2raytun = (payload) => 'v2raytun://import/' + encodeURIComponent(payload);
  const intentV2raytun = (payload) => {
    const enc = encodeURIComponent(payload);
    const fb  = encodeURIComponent('https://play.google.com/store/apps/details?id=com.v2raytun.android');
    return `intent://import/${enc}#Intent;scheme=v2raytun;package=com.v2raytun.android;S.browser_fallback_url=${fb};end`;
  };

  // добавляем encryption=none, если его нет (Android это требует)
  function normalizeVless(vless){
    const [noFrag, ...fragParts] = vless.split('#');
    const frag = fragParts.length ? '#' + fragParts.join('#') : '';
    const qPos = noFrag.indexOf('?');
    const base = qPos === -1 ? noFrag : noFrag.slice(0, qPos);
    const queryRaw = qPos === -1 ? '' : noFrag.slice(qPos + 1);
    const q = new URLSearchParams(queryRaw);
    if (!q.has('encryption')) q.set('encryption', 'none');
    return base + '?' + q.toString() + frag;
  }

  async function getVLESS(){
    const r = await fetch('/sub?id=' + id, { cache:'no-store' });
    if(!r.ok) throw new Error('sub?id=' + id + ' not available');
    return (await r.text()).trim(); // одна строка vless://...
  }

  async function init(){
    await ensureSW();
    const vlessRaw = await getVLESS();

    // iOS — как было
    btnIOS.href = deepV2raytun(vlessRaw);

    // ANDROID — только эта кнопка изменена
    const vlessFixed = normalizeVless(vlessRaw);
    const linkIntent = intentV2raytun(vlessFixed);
    const linkDirect = deepV2raytun(vlessFixed);

    if (isAndroid) {
      // Важно: первая навигация происходит БЕЗ preventDefault и await
      btnAndroid.href = linkIntent;
      // Фолбэк — уже после первой попытки
      btnAndroid.addEventListener('click', () => {
        setTimeout(()=>{ try{ location.href = linkDirect; }catch(_){} }, 800);
      }, { passive: true });
    } else {
      // Windows/десктоп — если протокол зарегистрирован
      btnAndroid.href = linkDirect;
    }

    // Скопировать ключ — без изменений
    btnCopy.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(vlessRaw);
        showToast('Ключ скопирован');
      }catch{
        const ta = document.createElement('textarea');
        ta.value = vlessRaw; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
        showToast('Ключ скопирован');
      }
    });
  }
</script>
